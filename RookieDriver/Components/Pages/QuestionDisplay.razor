@page "/question"
@rendermode InteractiveServer
@inject NavigationManager navigationManager

@if (IsSubmitted)
{
    <MudGrid>
        <MudItem>
            <MudCard>
                <MudCardHeader>
                    <MudChip Size="Size.Large" Label="true" Color="Color.Info">
                        <AvatarContent>
                            <MudAvatar>@avatarName</MudAvatar>
                        </AvatarContent>
                        <ChildContent>Hello @username, Thank you for taking the test</ChildContent>
                    </MudChip>
                </MudCardHeader>
               @*  @if (UserScore >= @CurrentTest.PassScore)
                {
                    <MudCardMedia />
                }
                else
                {
                    <MudCardMedia>

                    </MudCardMedia>
                } *@
                <MudCardContent>
                    <MudText>You score is @UserScore / @CurrentTest.TotalScore</MudText>
                    @if (UserScore >= @CurrentTest.PassScore)
                    {
                        <MudText>Congratulations! You've passed the test.</MudText>
                    }
                    else
                    {
                        <MudText>Unfortunately! You've failed the test.</MudText>
                    }
                </MudCardContent>
                <MudCardActions>
                    <MudButton Variant="Variant.Text" Color="Color.Primary" OnClick="@FinishTest">Finish Test</MudButton>
                </MudCardActions>
            </MudCard>
        </MudItem>
    </MudGrid>
}
else
{
    <MudGrid>
        <MudItem xs="6">
            <MudCard>
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText>Question @(index + 1) </MudText>
                        <MudText>@DisplayQuestion.Description</MudText>
                    </CardHeaderContent>
                </MudCardHeader>
                <MudCardContent>
                    <MudGrid>
                        <MudItem md="4">
                            <MudRadioGroup Name="Options" @bind-Value="@DisplayQuestion.UserAnswer">
                                @foreach (var option in DisplayQuestion.Options)
                                {
                                    <MudRadio Value="@option.Id">@option.Description</MudRadio>
                                }
                            </MudRadioGroup>
                        </MudItem>
                    </MudGrid>
                </MudCardContent>
                <MudCardActions>
                    @if (index < CurrentTest.TotalScore - 1)
                    {
                        <MudButton Variant="Variant.Text" Color="Color.Primary" OnClick="@Next">Next Question</MudButton>
                    }
                    else if (index == CurrentTest.TotalScore - 1)
                    {
                        <MudButton Variant="Variant.Text" Color="Color.Primary" OnClick="@SubmitTest">Finish Test</MudButton>
                    }
                </MudCardActions>
            </MudCard>
        </MudItem>
    @if (!string.IsNullOrEmpty(DisplayQuestion.FileName))
    {
        <MudItem xs="6">
            <MudImage Src="@DisplayQuestion.ImageFilePath" />
        </MudItem>
    }
    </MudGrid>
}
@code {
    ///  <summary>
    ///  This is my change
    /// </summary>
    private Question DisplayQuestion; //current question to be displayed
    private int index = 0; // position of the question in the list
    private int UserScore = 0;
    private bool IsSubmitted = false; // flag to check if test is submitted.
    private Test CurrentTest = new Test();

    public string username { get; set; }


    private string avatarName => username?.Substring(0, 2);
    private QuestionManager _QManager = new QuestionManager();
    private UserManager _UManager = new UserManager();

    /// <summary>
    /// To Start off your page with initial Data
    /// </summary>
    protected override void OnInitialized()
    {
        if(!RookieDriverContext.IsUserLoggedIn)
        {
            navigationManager.NavigateTo($"/", forceLoad: true);
        }

        username = RookieDriverContext.LoggedInUsername;

        CurrentTest.TotalScore = _QManager.TotalQuestionCount();
        CurrentTest.PassScore = _QManager.PassScoreCount();
        CurrentTest.TestDate = DateTime.Now.Date;
        CurrentTest.Username = username;

        CurrentTest.QuestionList = _QManager.GiveRandomQuestions();
        //CurrentTest.QuestionList = _QManager.GiveAllQuestions();

        DisplayQuestion = CurrentTest.QuestionList[index];
    }

    public void Next()
    {
        if (CurrentTest.QuestionList[index].UserAnswer != 0)
        {
            index++;
            DisplayQuestion = CurrentTest.QuestionList[index];
        }
    }

    public void FinishTest()
    {
        navigationManager.NavigateTo($"/user", forceLoad: true);
    }

    public void SubmitTest()
    {
        foreach (Question qAnswered in CurrentTest.QuestionList)
        {
            if(qAnswered.CorrectAnswer == qAnswered.UserAnswer)
            {
                UserScore = UserScore + 1;
            }
        }

        CurrentTest.FinalScore = UserScore;

        _UManager.SaveTest(CurrentTest);

        IsSubmitted = true;
    }
}


